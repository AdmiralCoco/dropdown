<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="d2l-menu-item.html">
<link rel="import" href="d2l-menu-item-return.html">
<link rel="import" href="d2l-menu-item-separator.html">

<dom-module id="d2l-menu">

	<template>
		<style include="d2l-colors">

			:host {
				box-sizing: border-box;
				display: block;
				position: relative;
				width: 100%;
				overflow: hidden;
			}
			.d2l-menu-items {
				position: absolute;
				width: 100%;
			}
			.d2l-menu-items ::content > [role="menuitem"] {
				border: 1px solid var(--d2l-color-titanius);
				border-top-color: var(--d2l-color-gypsum);
				border-bottom-color: transparent;
			}
			.d2l-menu-items d2l-menu-item-return[role="menuitem"] {
				border: 1px solid var(--d2l-color-titanius);
				border-bottom-color: transparent;
				border-top-left-radius: 0.3rem;
				border-top-right-radius: 0.3rem;
			}
			.d2l-menu-items ::content > [role="menuitem"]:first-of-type {
				border-top-color: var(--d2l-color-titanius);
				border-top-left-radius: 0.3rem;
				border-top-right-radius: 0.3rem;
			}
			:host([sub-view]) ::content > [role="menuitem"]:first-of-type {
				border-top-color: var(--d2l-color-gypsum);
				border-radius: 0;
			}
			.d2l-menu-items ::content > [role="menuitem"]:last-of-type {
				border-bottom-left-radius: 0.3rem;
				border-bottom-right-radius: 0.3rem;
				border-bottom-color: var(--d2l-color-titanius);
			}
			.d2l-menu-items d2l-menu-item-return[role="menuitem"]:focus,
			.d2l-menu-items d2l-menu-item-return[role="menuitem"]:hover,
			.d2l-menu-items ::content > [role="menuitem"]:focus,
			.d2l-menu-items ::content > [role="menuitem"]:hover {
				background-color: var(--d2l-color-celestine-light-1);
				border: 1px solid var(--d2l-color-celestine-light-2);
			}
			.d2l-menu-items ::content > [role="menuitem"]:focus:last-of-type,
			.d2l-menu-items ::content > [role="menuitem"]:hover:last-of-type {
				border-bottom-color: var(--d2l-color-celestine-light-2);
			}
			.d2l-menu-items.d2l-menu-item-return-hover ::content > [role="menuitem"]:first-of-type,
			.d2l-menu-items.d2l-menu-item-return-focus ::content > [role="menuitem"]:first-of-type,
			.d2l-menu-items ::content > [role="menuitem"]:focus + [role="menuitem"],
			.d2l-menu-items ::content > [role="menuitem"]:hover + [role="menuitem"] {
				border-top-color: transparent;
			}
			.d2l-menu-items ::content > d2l-menu-item-separator {
				border: 0;
			}
			.d2l-menu-items ::content > d2l-menu-item-separator + [role="menuitem"] {
				border-top: 1px solid var(--d2l-color-pressicus);
			}
			.d2l-menu-items ::content > [role="menuitem"]:focus + d2l-menu-item-separator + [role="menuitem"],
			.d2l-menu-items ::content > [role="menuitem"]:hover + d2l-menu-item-separator + [role="menuitem"] {
				border-top-color: transparent;
			}
			.d2l-menu-items.d2l-menu-sub-view-displayed {
				left: -100%; /* strangely, this is needed for FF */
				animation: d2l-menu-animation 300ms linear;
				-webkit-animation: d2l-menu-animation 300ms linear;
			}
			.d2l-menu-items.d2l-menu-sub-view-hidden {
				animation: d2l-menu-hide-animation 300ms linear;
				-webkit-animation: d2l-menu-hide-animation 300ms linear;
			}

			@keyframes d2l-menu-animation {
				0% { transform: translate(0,0); }
				100% { transform: translate(-100%,0); }
			}
			@-webkit-keyframes d2l-menu-animation {
				0% { -webkit-transform: translate(0,0); }
				100% { -webkit-transform: translate(-100%,0); }
			}
			@keyframes d2l-menu-hide-animation {
				0% { transform: translate(-100%,0); }
				100% { transform: translate(0,0); }
			}
			@-webkit-keyframes d2l-menu-hide-animation {
				0% { -webkit-transform: translate(-100%,0); }
				100% { -webkit-transform: translate(0,0); }
			}

		</style>
		<div class="d2l-menu-items"><content></content></div>
	</template>

	<script>
		Polymer({
			is: 'd2l-menu',

			hostAttributes: {
				'role': 'menu'
			},

			listeners: {
				'_focus': '_handleMenuItemFocus',
				'_blur': '_handleMenuItemBlur',
				'_mouseenter': '_handleMenuItemMouseEnter',
				'_mouseleave': '_handleMenuItemMouseLeave',
				'_resize-requested': '_handleResizeRequested',
				'_sub-view-hidden': '_handleSubViewHidden',
				'_sub-view-displayed': '_handleSubViewDisplayed',
				'keydown': '_handleKeyDown',
				'keypress': '_handleKeyPress'
			},

			properties: {
				subView: {
					type: Boolean,
					observer: '_subViewChanged',
					reflectToAttribute: true
				},
				label: {
					type: String,
					observer: '_labelChanged',
					reflectToAttribute: true
				}
			},

			_keyCodes: {
				DOWN: 40,
				ENTER: 13,
				ESCAPE: 27,
				LEFT: 37,
				SPACE: 32,
				RIGHT: 39,
				UP: 38
			},

			_items: null,

			ready: function() {
				this._labelChanged(this.label);
				this._items = this._getMenuItems();
				Polymer.dom(this).observeNodes(this._handleItemsChanged);
			},

			attached: function() {
				this.async(function() {
					this._autoSize();
				}.bind(this));
			},

			focus: function() {
				this._focusFirst();
			},

			_autoSize: function() {
				var itemsRect = this.$$('.d2l-menu-items').getBoundingClientRect();
				this.style.height = itemsRect.height + 'px';
				return {
					height: itemsRect.height,
					width: itemsRect.width
				};
			},

			_createReturnItem: function() {
				var item = document.createElement('d2l-menu-item-return');
				Polymer.dom(item).setAttribute('text', this.label);
				return item;
			},

			_focusFirst: function() {
				var item = this._tryGetNextFocusable();
				if (item) {
					item.focus();
				}
			},

			_focusLast: function() {
				var item = this._tryGetPreviousFocusable();
				if (item) {
					item.focus();
				}
			},

			_focusNext: function(item) {
				item = this._tryGetNextFocusable(item);
				item ? item.focus() : this._focusFirst();
			},

			_focusPrevious: function(item) {
				item = this._tryGetPreviousFocusable(item);
				item ? item.focus() : this._focusLast();
			},

			_getMenuItems: function() {
					var items = this.getEffectiveChildren();
					var returnItem = this.$$('d2l-menu-item-return');
					if (returnItem) {
						items.unshift(returnItem);
					}
					return items;
			},

			_handleItemsChanged: function() {
				this._items = this._getMenuItems();
				for(var i=0; i<this._items.length; i++) {
					if (this._items[i].tagName !== 'D2L-MENU-ITEM-SEPARATOR') {
						Polymer.dom(this._items[i]).setAttribute('tabindex', i===0 ? 0 : -1 );
					}
				}
			},

			_handleKeyDown: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (e.keyCode === this._keyCodes.DOWN || e.keyCode === this._keyCodes.UP) {
					// prevent scrolling when up/down arrows pressed
					e.preventDefault();
					e.stopPropagation();
					if (e.keyCode === this._keyCodes.DOWN) {
						this._focusNext(rootTarget);
					} else if (e.keyCode === this._keyCodes.UP) {
						this._focusPrevious(rootTarget);
					}
					return;
				}
				if (this.subView && (e.keyCode === this._keyCodes.ESCAPE || e.keyCode === this._keyCodes.LEFT)) {
					this.fire('_sub-view-hidden');
					e.stopPropagation();
					return;
				}
			},

			_handleKeyPress: function(e) {

				if (e.keyCode === this._keyCodes.DOWN || e.keyCode === this._keyCodes.UP
					|| e.keyCode === this._keyCodes.SPACE || e.keyCode === this._keyCodes.ENTER
					|| e.keyCode === this._keyCodes.ESCAPE ) {
					return;
				}

				e.stopPropagation();

				var startsWith = function(item, value) {
					if (item.text && item.text.length > 0
						&& item.text.substr(0,1) === value) {
							return true;
					}
					return false;
				};

				var focusableItems = this._items.filter(this._isFocusable, this);
				if (!focusableItems || focusableItems.length === 0) {
					return;
				}

				var targetItemIndex = focusableItems.indexOf(Polymer.dom(e).rootTarget);

				var getNextOrFirstIndex = function(itemIndex) {
					if (itemIndex === focusableItems.length - 1) {
						return 0;
					}
					return itemIndex + 1;
				}.bind(this);

				var searchChar = String.fromCharCode(e.charCode);

				var itemIndex = getNextOrFirstIndex(targetItemIndex);
				while (itemIndex !== targetItemIndex) {
					var item = focusableItems[itemIndex];
					if (startsWith(item, searchChar)) {
						item.focus();
						return;
					}
					itemIndex = getNextOrFirstIndex(itemIndex);
				}

			},

			_handleMenuItemBlur: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (rootTarget === this.$$('d2l-menu-item-return')) {
					Polymer.dom(this.$$('.d2l-menu-items')).classList.remove('d2l-menu-item-return-focus');
				}
			},

			_handleMenuItemFocus: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (rootTarget === this.$$('d2l-menu-item-return')) {
					Polymer.dom(this.$$('.d2l-menu-items')).classList.add('d2l-menu-item-return-focus');
				}
			},

			_handleMenuItemMouseEnter: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (rootTarget === this.$$('d2l-menu-item-return')) {
					Polymer.dom(this.$$('.d2l-menu-items')).classList.add('d2l-menu-item-return-hover');
				}
			},

			_handleMenuItemMouseLeave: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (rootTarget === this.$$('d2l-menu-item-return')) {
					Polymer.dom(this.$$('.d2l-menu-items')).classList.remove('d2l-menu-item-return-hover');
				}
			},

			_handleResizeRequested: function(e, detail) {
				if (!this.subView) {
					var view = detail.view;
					if (view._autoSize) {
						var size = view._autoSize();
						this.style.height = size.height + 'px';
					} else {
						this.style.height = view.getBoundingClientRect().height + 'px';
					}
				}
			},

			_handleSubViewDisplayed: function(e) {

				if (this._items.indexOf(Polymer.dom(e).localTarget) === -1) {
					return;
				}
				Polymer.dom(this.$$('.d2l-menu-items')).classList.add('d2l-menu-sub-view-displayed');
				Polymer.dom(this.$$('.d2l-menu-items')).classList.remove('d2l-menu-sub-view-hidden');

			},

			_handleSubViewHidden: function(e) {

				var localTarget = Polymer.dom(e).localTarget;
				if (localTarget === this) {
					return;
				}
				if (this.querySelector('[sub-view-displayed]') === null) {
					e.stopPropagation();
					Polymer.dom(this.$$('.d2l-menu-items')).classList.remove('d2l-menu-sub-view-displayed');
					Polymer.dom(this.$$('.d2l-menu-items')).classList.add('d2l-menu-sub-view-hidden');
					this.fire('_resize-requested', { view: this });
				}

			},

			_isFocusable: function(item) {
				if (item.nodeType !== 1) {
					return false;
				}
				if (item.getAttribute('tabindex') !== '0' && item.getAttribute('tabindex') !== '-1') {
					return false;
				}
				if (window.getComputedStyle(item, null).getPropertyValue("display") === 'none') {
					return false;
				}
				return true;
			},

			_labelChanged: function(newValue) {
				this.setAttribute('aria-label', newValue);
				var returnItem = this.$$('d2l-menu-item-return');
				if (returnItem) {
					Polymer.dom(returnItem).setAttribute('text', newValue);
				}
			},

			_subViewChanged: function(newValue) {
				var returnItem = this.$$('d2l-menu-item-return');
				if (!newValue && returnItem) {

					Polymer.dom(this.root).removeChild(returnItem);

				} else if (newValue && !returnItem) {

					var items = this.$$('.d2l-menu-items');
					Polymer.dom(items).insertBefore(
						this._createReturnItem(),
						Polymer.dom(items).childNodes[0]
					);
				}
			},

			_tryGetPreviousFocusable: function(item) {

				var focusableItems = this._items.filter(this._isFocusable, this);
				if (!focusableItems || focusableItems.length === 0) {
					return;
				}

				if (!item) {
					return focusableItems[focusableItems.length - 1];
				}

				var itemIndex = focusableItems.indexOf(item);
				if (itemIndex === 0) {
					return;
				}

				return focusableItems[itemIndex - 1];

			},

			_tryGetNextFocusable: function(item) {

				var focusableItems = this._items.filter(this._isFocusable, this);
				if (!focusableItems || focusableItems.length === 0) {
					return;
				}

				if (!item) {
					return focusableItems[0];
				}

				var itemIndex = focusableItems.indexOf(item);
				if (itemIndex === focusableItems.length - 1) {
					return;
				}

				return focusableItems[itemIndex + 1];

			}

		});
	</script>

</dom-module>
