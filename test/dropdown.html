<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>d2l-dropdown basic tests</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
		<script src="../../web-component-tester/browser.js"></script>
		<link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
		<link rel="import" href="../d2l-dropdown.html">
	</head>
	<body tabindex="-1">
		<button id="opener">opener</button>

		<test-fixture id="Dropdown">
			<template>
				<div>
					<d2l-dropdown id="dropdown" target-id="opener">
						<p>Lorem ipsum dolor sit...</p>
						<button id="elem_inside">in here</button>
					</d2l-dropdown>
					<button id="elem_outside">out here</p>
				</div>
			</template>
		</test-fixture>

		<test-fixture id="NoFocusable">
			<template>
				<d2l-dropdown id="dropdown" target-id="opener">
					<p>Lorem ipsum dolor sit...</p>
				</d2l-dropdown>
			</template>
		</test-fixture>

		<script>

		describe('<d2l-dropdown>', function() {

			describe('general', function() {

				var dropdownFixture, dropdown;

				beforeEach(function() {
					dropdownFixture = fixture('Dropdown');
					dropdown = dropdownFixture.querySelector('#dropdown');
				});

				it('distributes its children', function() {
					var content = dropdown.getContentChildren();
					expect(content.length).to.equal(2);
					expect(content[0]).to.equal(dropdown.querySelector('p'));
				});

				describe('events', function() {

					it('fires open event when open attribute is added', function(done) {
						dropdown.addEventListener('open', function() {
							expect(dropdown.opened).to.be.true;
							done();
						});
						dropdown.setAttribute('opened', true);
					});

					it('fires close event when open attribute is removed', function(done) {
						dropdown.addEventListener('open', function() {
							dropdown.removeAttribute('opened');
						});
						dropdown.addEventListener('close', function() {
							expect(dropdown.opened).to.be.false;
							done();
						});
						dropdown.setAttribute('opened', true);
					});

				});

				describe('auto-focus', function() {

					it('focuses on descendant when opened', function(done) {
						dropdown.addEventListener('open', function() {
							expect(dropdown.__container.getAttribute('tabindex')).to.be.null;
							expect(document.activeElement).to.equal(dropdown.querySelector('#elem_inside'));
							done();
						});
						dropdown.setAttribute('opened', true);
					});

					it('does not focus on descendant when opened and no-auto-focus attribute is specified', function(done) {
						var activeElement = document.activeElement;
						dropdown.addEventListener('open', function() {
							expect(document.activeElement).to.equal(activeElement);
							done();
						});
						dropdown.setAttribute('no-auto-focus', true);
						dropdown.setAttribute('opened', true);
					});

				});

				describe('auto-close', function() {

					it('should close when focus element outside receives focus', function(done) {
						dropdown.addEventListener('open', function() {
							dropdownFixture.querySelector('#elem_outside').focus();
						});
						dropdown.addEventListener('close', function() {
							expect(dropdown.opened).to.be.false;
							done();
						});
						dropdown.setAttribute('opened', true);
					});

					it('should not close when element outside receives focus and no-auto-close is set', function(done) {
						dropdown.addEventListener('open', function() {
							dropdownFixture.querySelector('#elem_outside').focus();
							setTimeout(function() {
								expect(dropdown.opened).to.be.true;
								done();
							},100);
						});
						dropdown.setAttribute('no-auto-close', true);
						dropdown.setAttribute('opened', true);
					});

					it('should not close when element inside receives focus', function(done) {
						dropdown.addEventListener('open', function() {
							dropdown.querySelector('#elem_inside').focus();
							setTimeout(function() {
								expect(dropdown.opened).to.be.true;
								done();
							}, 100);
						});
						dropdown.setAttribute('opened', true);
					});

					it('should not close when activeElement becomes body', function(done) {
						dropdown.addEventListener('open', function() {
							// this simulates a click on an element inside the dropdown,
							// which causes focus to be lost and activeElement to become
							// document.body
							document.body.focus();
							setTimeout(function() {
								expect(dropdown.opened).to.be.true;
								done();
							}, 100);
						});
						dropdown.setAttribute('opened', true);
					});

					it('should not close when element inside is clicked', function(done) {
						dropdown.addEventListener('open', function() {
							MockInteractions.tap(dropdown.querySelector('#elem_inside'));
							setTimeout(function() {
								expect(dropdown.opened).to.be.true;
								done();
							}, 100);
						});
						dropdown.setAttribute('opened', true);
					});

					it('should close when element outside is clicked', function(done) {
						dropdown.addEventListener('open', function() {
							MockInteractions.tap(dropdownFixture.querySelector('#elem_outside'));
						});
						dropdown.addEventListener('close', function() {
							done();
						});
						dropdown.setAttribute('opened', true);
					});

					it('should not close when element outside is clicked and no-auto-close', function(done) {
						dropdown.addEventListener('open', function() {
							MockInteractions.tap(dropdownFixture.querySelector('#elem_outside'));
							setTimeout(function() {
								expect(dropdown.opened).to.be.true;
								done();
							}, 100);
						});
						dropdown.setAttribute('no-auto-close', true);
						dropdown.setAttribute('opened', true);
					});

				});

			});

			describe('no focusable content', function() {

				var noFocusable;

				beforeEach(function() {
					noFocusable = fixture('NoFocusable');
				});

				it('focuses on container when opened and no focusable light descendant exists', function(done) {
					noFocusable.addEventListener('open', function() {
						expect(noFocusable.__container.getAttribute('tabindex')).to.equal('-1');
						if (noFocusable.shadowRoot) {
							expect(document.activeElement).to.equal(noFocusable);
							expect(noFocusable.shadowRoot.activeElement).to.equal(noFocusable.__container);
						} else {
							expect(document.activeElement).to.equal(noFocusable.__container);
						}
						done();
					});
					noFocusable.setAttribute('opened', true);
				});

			});

		});
		</script>
	</body>
</html>
