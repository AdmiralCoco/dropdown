<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-polymer-behaviors/d2l-dom-focus.html">
<link rel="import" href="position-behavior.html">
<script>
(function() {
	'use strict';

	/** @polymerBehavior */
	var DropdownBehavior = {

		__container: null,
		__opener: null,
		__target: null,

		properties: {
			noAutoClose: {
				type: Boolean
			},
			noAutoFit: {
				type: Boolean
			},
			noAutoFocus: {
				type: Boolean
			},
			opened: {
				type: Boolean,
				observer: '__openedChanged',
				reflectToAttribute: true
			},
			openerId: String,
			horizontalOffset: {
				type: Number,
				value: 0
			},
			targetId: String,
			verticalOffset: {
				type: Number,
				value: 20
			}
		},

		listeners: {
			'close': '__onClose',
			'keyup': '__onKeyUp'
		},

		ready: function() {
			this.__onResize = this.__onResize.bind(this);
			this.__onAutoClose = this.__onAutoClose.bind(this);
		},

		attached: function() {
			document.body.addEventListener('focus', this.__onAutoClose, true);
			document.body.addEventListener('click', this.__onAutoClose, true);
			window.addEventListener('resize', this.__onResize);
		},

		detached: function() {
			document.body.removeEventListener('focus', this.__onAutoClose, true);
			document.body.removeEventListener('click', this.__onAutoClose, true);
			window.removeEventListener('resize', this.__onResize);
		},

		close: function() {
			this.opened = false;
		},

		open: function(target, opener) {
			if (!opener) {
				this.__opener = target;
			}
			this.__target = target;
			this.opened = true;
		},

		__onAutoClose: function() {

			if (!this.opened || this.noAutoClose) {
				return;
			}

			setTimeout(function() {
				if (!this.opened || !document.activeElement) {
					return;
				}
				if (this.__isDeepChild(document.activeElement)) {
					return;
				}
				this.opened = false;
			}.bind(this), 0);

		},

		__onClose: function(e) {
			if (e.target !== this || !document.activeElement) {
				return;
			}
			if (!this.__isDeepChild(document.activeElement)) {
				return;
			}
			this.__opener.focus();
		},

		__onKeyUp: function(e) {
			if (!this.opened) {
				return;
			}
			if (e.keyCode === 27) {
				// escape
				this.opened = false;
			}
		},

		__onResize: function() {
			if (!this.opened) {
				return;
			}
			this.__position();
		},

		__isDeepChild: function(elem) {
			var parentNode = elem.parentNode;
			while (parentNode) {
				if (Polymer.dom(parentNode).node === this) {
					return true;
				}
				parentNode = parentNode.parentNode;
			}
			return false;
		},

		__openedChanged: function(newValue) {

			if (!this.__target) {
				this.__target = document.getElementById(this.targetId);
				if (!this.__target) {
					return;
				}
			}
			if (!this.__opener && this.openerId) {
				this.__opener = document.getElementById(this.openerId);
			}
			if (!this.__opener) {
				this.__opener = this.__target;
			}

			if (newValue) {

				if (!this.noAutoFit) {
					this.$$('.d2l-dropdown-content-container').scrollTop = 0;
				}

				this.__position();

				if (!this.noAutoFocus) {
					var focusable = D2L.Dom.Focus.getFirstFocusableDescendant(this);
					if (focusable) {
						focusable.focus();
					} else {
						Polymer.dom(this.__container).setAttribute('tabindex', '-1');
						this.__container.focus();
					}
				}

				this.fire('open');

			} else {

				this.fire('close');

				return;
			}

		},

		__getOffset: function() {
			return {
				horizontal: this.horizontalOffset,
				vertical: this.verticalOffset
			};
		},

		__position: function() {

			var content = this.$$('.d2l-dropdown-content-container');

			if (!this.noAutoFit) {
				content.style.maxHeight = 'none';
			}

			var position = this._autoPosition(
					this.__container,
					this.__target,
					this.__getOffset()
				);

			var maxHeight;

			if (position.vertical !== 'above') {
				maxHeight = position.spaceAround.below - 40;
				this.__container.classList.remove('d2l-dropdown-flip-x');
			} else {
				maxHeight = position.spaceAround.above - 40;
				this.__container.classList.add('d2l-dropdown-flip-x');
			}

			if (!this.noAutoFit && maxHeight && maxHeight > 0) {
				content.style.maxHeight = maxHeight + 'px';
				content.style.overflowY = 'auto';
			}

			if (position.horizontal !== 'right') {
				this.__container.classList.remove('d2l-dropdown-flip-y');
			} else {
				this.__container.classList.add('d2l-dropdown-flip-y');
			}

		}

	};

	window.D2L = window.D2L || {};
	window.D2L.PolymerBehaviors = window.D2L.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2L.PolymerBehaviors.DropdownBehavior = [
		window.D2L.PolymerBehaviors.PositionBehavior,
		DropdownBehavior
	];
})();
</script>
