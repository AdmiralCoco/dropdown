<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="position-behavior.html">
<script>
(function() {
	'use strict';

	var DropdownBehavior = {

		_container: null,
		_offset: { vertical: 20, horizontal: 0},
		_opener: null,
		_target: null,

		properties: {
			noAutoClose: {
				type: Boolean
			},
			opened: {
				type: Boolean,
				observer: '_openedChanged',
				reflectToAttribute: true
			},
			openerId: String,
			targetId: String
		},

		ready: function() {
			this._handleResize = this._handleResize.bind(this);
		},

		detached: function() {
			this.removeEventListener('blur', this._handleBlur);
			this.removeEventListener('keyup', this._handleKeyUp);
			window.removeEventListener('resize', this._handleResize);
		},

		close: function() {
			this.opened = false;
		},

		open: function(target, opener) {
			if (!opener) {
				this._opener = target;
			}
			this._target = target;
			this.opened = true;
		},

		_handleBlur: function() {

			if (this.noAutoClose) {
				return;
			}

			setTimeout(function() {
				if (!this.opened || !document.activeElement) {
					return;
				}
				if (this._isDeepChild(document.activeElement)){
					return;
				}
				Polymer.dom(this).removeAttribute('opened');
			}.bind(this), 0);

		},

		_handleKeyUp: function(e) {
			if (e.keyCode === 27) {
				// escape
				this.opened = false;
			}
		},

		_handleResize: function() {
			this._position();
		},

		_isDeepChild: function(elem) {
			var parentNode = elem.parentNode;
			while (parentNode) {
				if (Polymer.dom(parentNode).node === this) {
					return true;
				}
				parentNode = parentNode.parentNode;
			}
			return false;
		},

		_openedChanged: function(newValue) {

			if (!this._target) {
				this._target = document.getElementById(this.targetId);
				if (!this._target) {
					return;
				}
			}
			if (!this._opener && this.openerId) {
				this._opener = document.getElementById(this.openerId);
			}
			if (!this._opener) {
				this._opener = this._target;
			}

			if (newValue) {
				this.addEventListener('blur', this._handleBlur, true);
				this.addEventListener('keyup', this._handleKeyUp);
				window.addEventListener('resize', this._handleResize);
				this._container.focus();
				this.fire('d2l-dropdown-opened');

			} else {

				this.removeEventListener('blur', this._handleBlur);
				this.removeEventListener('keyup', this._handleKeyUp);
				window.removeEventListener('resize', this._handleResize);
				this.fire('d2l-dropdown-closed');

				return;
			}

			this._position();

		},

		_position: function() {

			var position = this._autoPosition(
					this._container,
					this._target,
					this._offset
				);

			if (position.vertical !== 'above') {
				this._container.classList.remove('d2l-dropdown-flip-x');
			} else {
				this._container.classList.add('d2l-dropdown-flip-x');
			}

			if (position.horizontal !== 'right') {
				this._container.classList.remove('d2l-dropdown-flip-y');
			} else {
				this._container.classList.add('d2l-dropdown-flip-y');
			}

		}

	};

	window.D2L = window.D2L || {};
	window.D2L.PolymerBehaviors = window.D2L.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2L.PolymerBehaviors.DropdownBehavior = [
		window.D2L.PolymerBehaviors.PositionBehavior,
		DropdownBehavior
	];
})();
</script>
