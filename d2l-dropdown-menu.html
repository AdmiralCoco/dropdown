<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-menu/d2l-menu.html">
<link rel="import" href="d2l-dropdown-content-behavior.html">

<dom-module id="d2l-dropdown-menu">

	<template>
		<style include="d2l-colors d2l-dropdown-content-styles">

			:host .d2l-dropdown-content-top,
			:host .d2l-dropdown-content-bottom {
				height: 10px;
				position: relative;
				z-index: 1;
			}

			:host .d2l-dropdown-content-top {
				border-top-left-radius: 0.3rem;
				border-top-right-radius: 0.3rem;
			}

			:host .d2l-dropdown-content-bottom {
				border-bottom-left-radius: 0.3rem;
				border-bottom-right-radius: 0.3rem;
			}

			:host .d2l-dropdown-content-top-scroll {
				box-shadow: 0 3px 3px 0 rgba(0, 0, 0, 0.05);
			}

			:host .d2l-dropdown-content-bottom-scroll {
				box-shadow: 0 -3px 3px 0 rgba(0, 0, 0, 0.05);
			}

		</style>
		<div class="d2l-dropdown-content-position">
			<div class="d2l-dropdown-content-width">
				<div class="d2l-dropdown-content-top"></div>
				<div on-scroll="_onScroll" class="d2l-dropdown-content-container">
					<content></content>
				</div>
				<div class="d2l-dropdown-content-bottom"></div>
			</div>
		</div>
		<div class="d2l-dropdown-content-pointer">
			<div></div>
		</div>
	</template>

	<script>
		Polymer({
			is: 'd2l-dropdown-menu',

			behaviors: [
				window.D2L.PolymerBehaviors.DropdownContentBehavior
			],

			listeners: {
				'd2l-dropdown-close': '_onClose',
				'd2l-dropdown-open': '_onOpen',
				'd2l-dropdown-position': '_onPosition',
				'd2l-menu-resize': '_onMenuResize',
				'select': '_onSelect'
			},

			_content: null,

			ready: function() {
				this.noAutoFocus = true;
				this.noPadding = true;
				this._content = this.$$('.d2l-dropdown-content-container');
			},

			_onClose: function(e) {

				if (e.target !== this) {
					return;
				}

				// reset to root view
				var menu = this.queryEffectiveChildren('[role="menu"]');
				menu.show({ preventFocus: true });

			},

			_onMenuResize: function() {
				this.__position(!this._initializingHeight);
				this._initializingHeight = false;
			},

			_onOpen: function(e) {

				if (e.target !== this) {
					return;
				}

				this._initializingHeight = true;

				var menu = this.queryEffectiveChildren('[role="menu"]');

				Polymer.dom(menu).setAttribute('no-animate-height', '');
				menu.resize();

				setTimeout(function() {
					menu.focus();
				}, 0);

			},

			_onPosition: function() {
				this._toggleScrollStyles();
			},

			_onScroll: function() {
				this._toggleScrollStyles();
			},

			_onSelect: function(e) {
				if (e.target.tagName !== 'D2L-MENU-ITEM') {
					return;
				}
				this.close();
			},

			_toggleScrollStyles: function() {
				var topCap = this.$$('.d2l-dropdown-content-top');
				var bottomCap = this.$$('.d2l-dropdown-content-bottom');
				if (this._content.scrollTop === 0) {
					if (topCap.classList.contains('d2l-dropdown-content-top-scroll')) {
						topCap.classList.remove('d2l-dropdown-content-top-scroll');
					}
				} else {
					if (!topCap.classList.contains('d2l-dropdown-content-top-scroll')) {
						topCap.classList.add('d2l-dropdown-content-top-scroll');
					}
				}

				/* scrollHeight incorrect in IE by 4px second time opened */
				if (this._content.scrollHeight - (this._content.scrollTop + this._content.clientHeight) < 5) {
					if (bottomCap.classList.contains('d2l-dropdown-content-bottom-scroll')) {
						bottomCap.classList.remove('d2l-dropdown-content-bottom-scroll');
					}
				} else {
					if (!bottomCap.classList.contains('d2l-dropdown-content-bottom-scroll')) {
						bottomCap.classList.add('d2l-dropdown-content-bottom-scroll');
					}
				}
			}

		});
	</script>

</dom-module>
