<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vui-colors/colors.html">
<link rel="import" href="menu-item.html">
<link rel="import" href="menu-item-return.html">
<link rel="import" href="menu-item-separator.html">

<dom-module id="d2l-menu">

	<template>
		<style include="vui-colors"></style>
		<style>

			:host {
				box-sizing: border-box;
				display: block;
			}
			:host ::content > [role="menuitem"] {
				border: 1px solid var(--vui-color-titanius);
				border-bottom-color: transparent;
			}
			:host([sub-view]) d2l-menu-item-return[role="menuitem"] {
				border: 1px solid var(--vui-color-titanius);
				border-bottom-color: transparent;
				border-top-left-radius: 0.4rem;
				border-top-right-radius: 0.4rem;
			}
			:host ::content > [role="menuitem"]:first-child {
				border-top-left-radius: 0.4rem;
				border-top-right-radius: 0.4rem;
			}
			:host([sub-view]) ::content > [role="menuitem"]:first-child {
				border-radius: 0;
			}
			:host ::content > [role="menuitem"]:last-child {
				border-bottom-left-radius: 0.4rem;
				border-bottom-right-radius: 0.4rem;
				border-bottom-color: var(--vui-color-titanius);
			}
			:host d2l-menu-item-return[role="menuitem"]:focus,
			:host d2l-menu-item-return[role="menuitem"]:hover,
			:host ::content > [role="menuitem"]:focus,
			:host ::content > [role="menuitem"]:hover {
				background-color: var(--vui-color-celestine-light-1);
				border: 1px solid var(--vui-color-celestine-light-2);
			}
			:host ::content > [role="menuitem"]:focus:last-child,
			:host ::content > [role="menuitem"]:hover:last-child {
				border-bottom-color: var(--vui-color-celestine-light-2);
			}
			:host([return-active]) ::content > [role="menuitem"]:first-child,
			:host ::content > [role="menuitem"]:focus + [role="menuitem"],
			:host ::content > [role="menuitem"]:hover + [role="menuitem"] {
				border-top-color: transparent;
			}
			:host ::content > d2l-menu-item-separator {
				border: 0;
			}
			:host ::content > d2l-menu-item-separator + [role="menuitem"] {
				border-top: 1px solid var(--vui-color-pressicus);
			}
			:host ::content > [role="menuitem"]:focus + d2l-menu-item-separator + [role="menuitem"],
			:host ::content > [role="menuitem"]:hover + d2l-menu-item-separator + [role="menuitem"] {
				border-top-color: transparent;
			}
			/*
			:host([show-sub-menu]) > d2l-menu-item-return[role="menuitem"],
			:host([show-sub-menu]) ::content > [role="menuitem"],
			:host([show-sub-menu]) ::content > d2l-menu-item-separator {
				display: none;
			}
			:host ::content > [role="menuitem"][show-sub-menu] {
				background-color: transparent;
				border-style: none;
				display: block;
			}
			*/
			:host([sub-view-displayed]) > d2l-menu-item-return[role="menuitem"],
			:host([sub-view-displayed]) ::content > [role="menuitem"],
			:host([sub-view-displayed]) ::content > d2l-menu-item-separator {
				display: none;
			}
			:host ::content > [role="menuitem"][sub-view-displayed] {
				background-color: transparent;
				border-style: none;
				display: block;
			}
			</style>
		<content></content>
	</template>

	<script>
		Polymer({
			is: 'd2l-menu',

			hostAttributes: {
				'role': 'menu'
			},

			listeners: {
				'_focus': '_handleMenuItemFocus',
				'_blur': '_handleMenuItemBlur',
				'_sub-view-hidden': '_handleSubViewHidden',
				'_sub-view-displayed': '_handleSubViewDisplayed',
				'keydown': '_handleKeyDown',
				'keypress': '_handleKeyPress',
				'keyup': '_handleKeyUp'
			},

			properties: {
				subView: {
					type: Boolean,
					observer: '_subViewChanged',
					reflectToAttribute: true
				},
				label: {
					type: String,
					observer: '_labelChanged',
					reflectToAttribute: true
				}
			},

			_keyCodes: {
				DOWN: 40,
				ENTER: 13,
				ESCAPE: 27,
				LEFT: 37,
				SPACE: 32,
				RIGHT: 39,
				UP: 38
			},

			_items: null,

			ready: function() {
				this._labelChanged(this.label);
				this._items = this._getMenuItems();
				Polymer.dom(this).observeNodes(this._handleItemsChanged);
			},

			focus: function() {
				this._focusFirst();
			},

			_handleMenuItemFocus: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (rootTarget === this.$$('d2l-menu-item-return')) {
					this.setAttribute('return-active', true);
					//this.$$('div').classList.add('d2l-menu-item-return-active');
				}
			},

			_handleMenuItemBlur: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (rootTarget === this.$$('d2l-menu-item-return')) {
					this.removeAttribute('return-active');
					//this.$$('div').classList.remove('d2l-menu-item-return-active');
				}
			},

			_createReturnItem: function() {
				var item = document.createElement('d2l-menu-item-return');
				Polymer.dom(item).setAttribute('text', this.label);
				return item;
			},

			_focusFirst: function() {
				var item = this._tryGetNextFocusable();
				if (item) {
					item.focus();
				}
			},

			_focusLast: function() {
				var item = this._tryGetPreviousFocusable();
				if (item) {
					item.focus();
				}
			},

			_focusPrevious: function(item) {
				item = this._tryGetPreviousFocusable(item);
				item ? item.focus() : this._focusLast();
			},

			_focusNext: function(item) {
				item = this._tryGetNextFocusable(item);
				item ? item.focus() : this._focusFirst();
			},

			_getMenuItems: function() {
					var items = this.getEffectiveChildren();
					var returnItem = this.$$('d2l-menu-item-return');
					if (returnItem) {
						items.unshift(returnItem);
					}
					return items;
			},

			_handleKeyDown: function(e) {
				if (e.keyCode === this._keyCodes.DOWN || e.keyCode === this._keyCodes.UP) {
					// prevent scrolling when up/down arrows pressed
					e.preventDefault();
					e.stopPropagation();
				}
			},

			_handleKeyPress: function(e) {

				if (e.keyCode === this._keyCodes.DOWN || e.keyCode === this._keyCodes.UP
					|| e.keyCode === this._keyCodes.SPACE || e.keyCode === this._keyCodes.ENTER
					|| e.keyCode === this._keyCodes.ESCAPE ) {
					return;
				}

				e.stopPropagation();

				var startsWith = function(item, value) {
					if (item.text && item.text.length > 0
						&& item.text.substr(0,1) === value) {
							return true;
					}
					return false;
				};

				var focusableItems = this._items.filter(this._isFocusable, this);
				if (!focusableItems || focusableItems.length === 0) {
					return;
				}

				var targetItemIndex = focusableItems.indexOf(Polymer.dom(e).rootTarget);

				var getNextOrFirstIndex = function(itemIndex) {
					if (itemIndex === focusableItems.length - 1) {
						return 0;
					}
					return itemIndex + 1;
				}.bind(this);

				var searchChar = String.fromCharCode(e.charCode);

				var itemIndex = getNextOrFirstIndex(targetItemIndex);
				while (itemIndex !== targetItemIndex) {
					var item = focusableItems[itemIndex];
					if (startsWith(item, searchChar)) {
						item.focus();
						return;
					}
					itemIndex = getNextOrFirstIndex(itemIndex);
				}

			},

			_handleKeyUp: function(e) {
				var rootTarget = Polymer.dom(e).rootTarget;
				if (e.keyCode === this._keyCodes.DOWN || e.keyCode === this._keyCodes.UP) {
					e.stopPropagation();
					if (e.keyCode === this._keyCodes.DOWN) {
						this._focusNext(rootTarget);
					} else if (e.keyCode === this._keyCodes.UP) {
						this._focusPrevious(rootTarget);
					}
					return;
				}
				if (this.subMenu && (e.keyCode === this._keyCodes.ESCAPE || e.keyCode === this._keyCodes.LEFT)) {
					this.fire('_hide-sub-menu');
					e.stopPropagation();
					return;
				}
			},

			_handleItemsChanged: function() {
				this._items = this._getMenuItems();
				for(var i=0; i<this._items.length; i++) {
					if (this._items[i].tagName !== 'D2L-MENU-ITEM-SEPARATOR') {
						Polymer.dom(this._items[i]).setAttribute('tabindex', i===0 ? 0 : -1 );
					}
				}
			},

			_handleSubViewDisplayed: function(e) {
				//console.log('show the sub view');
				//var rootTarget = Polymer.dom(e).rootTarget;
				//this._subViewOpenerIndex = this._items.indexOf(rootTarget)
				//this.setAttribute('show-sub-menu', true);
				var rootTarget = Polymer.dom(e).rootTarget;
				this._subViewOpenerIndex = this._items.indexOf(rootTarget)
				this.setAttribute('sub-view-displayed', true);
			},

			_handleSubViewHidden: function(e) {
				/*
				var localTarget = Polymer.dom(e).localTarget;
				if (localTarget === this) {
					return;
				}
				if (this.getAttribute('show-sub-menu') === 'true') {
					e.stopPropagation();
					this.removeAttribute('show-sub-menu');
					if (this._subViewOpenerIndex !== -1) {
						this._items[this._subViewOpenerIndex].focus();
					}
				}
				*/
				var localTarget = Polymer.dom(e).localTarget;
				if (localTarget === this) {
					return;
				}
				if (this.getAttribute('sub-view-displayed') === 'true') {
					e.stopPropagation();
					this.removeAttribute('sub-view-displayed');
					if (this._subViewOpenerIndex !== -1) {
						this._items[this._subViewOpenerIndex].focus();
					}
				}
			},

			_isFocusable: function(item) {
				if (item.nodeType !== 1) {
					return false;
				}
				if (item.getAttribute('tabindex') !== '0' && item.getAttribute('tabindex') !== '-1') {
					return false;
				}
				if (window.getComputedStyle(item, null).getPropertyValue("display") === 'none') {
					return false;
				}
				return true;
			},

			_labelChanged: function(newValue) {
				this.setAttribute('aria-label', newValue);
				var returnItem = this.$$('d2l-menu-item-return');
				if (returnItem) {
					Polymer.dom(returnItem).setAttribute('text', newValue);
				}
			},

			_subViewChanged: function(newValue) {
				var returnItem = this.$$('d2l-menu-item-return');
				if (!newValue && returnItem) {

					Polymer.dom(this.root).removeChild(returnItem);

				} else if (newValue && !returnItem) {

					Polymer.dom(this.root).insertBefore(
						this._createReturnItem(),
						Polymer.dom(this.root).childNodes[0]
					);

				}
			},

			_tryGetPreviousFocusable: function(item) {

				var focusableItems = this._items.filter(this._isFocusable, this);
				if (!focusableItems || focusableItems.length === 0) {
					return;
				}

				if (!item) {
					return focusableItems[focusableItems.length - 1];
				}

				var itemIndex = focusableItems.indexOf(item);
				if (itemIndex === 0) {
					return;
				}

				return focusableItems[itemIndex - 1];

			},

			_tryGetNextFocusable: function(item) {

				var focusableItems = this._items.filter(this._isFocusable, this);
				if (!focusableItems || focusableItems.length === 0) {
					return;
				}

				if (!item) {
					return focusableItems[0];
				}

				var itemIndex = focusableItems.indexOf(item);
				if (itemIndex === focusableItems.length - 1) {
					return;
				}

				return focusableItems[itemIndex + 1];

			}

		});
	</script>

</dom-module>
